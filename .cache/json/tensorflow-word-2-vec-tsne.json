{"data":{"markdownRemark":{"html":"<p><em>Posted on <a href=\"https://medium.freecodecamp.org/learn-tensorflow-the-word2vec-model-and-the-tsne-algorithm-using-rock-bands-97c99b5dcb3a\">freeCodeCamp</a></em>\n<img src=\"https://res.cloudinary.com/patricoferris/image/upload/v1534280789/pf2018/blogposts/14-08-2018/KMEANS_CLUSTERING.png\" alt=\"KMEAN Clustering of the Genres\"></p>\n<p>Learning the “TensorFlow way” to build a neural network can seem like a big hurdle to getting started with machine learning. In this tutorial, we’ll take it step by step and explain all of the critical components involved as we build a Bands2Vec model using <a href=\"https://www.kaggle.com/nolanbconaway/pitchfork-data\">Pitchfork</a> data from <a href=\"https://www.kaggle.com/nolanbconaway/pitchfork-data\">Kaggle</a>. For the full code, check out the GitHub <a href=\"https://github.com/patricoferris/machinelearning/blob/master/word2vec/Pitchfork.ipynb\">page</a>.</p>\n<h3>The Word2Vec Model</h3>\n<p>Neural networks consume numbers and produce numbers. They’re very good at it. But give them some text, and they’ll throw a tantrum and do nothing remotely interesting. If it is the neural network’s job to crunch the numbers and produce meaningful output, then it is our job to make sure that whatever we are feeding it is meaningful too. This quest for a meaningful representation of information gave birth to the Word2Vec model.</p>\n<p>One approach to working with words is to form <a href=\"https://en.wikipedia.org/wiki/One-hot\">one-hot encoded vectors</a>. Create a long (the number of distinct words in our vocabulary) list of zeroes, and have each word point to a unique index of this list. If we see this word, make that index in the list a number one.</p>\n<p>While this approach works, it requires a lot space and is completely devoid of meaning. ‘Good’ and ‘Excellent’ are as similar as ‘Duck’ and ‘Blackhole’. If only there was a way to vectorise words so that we preserved this contextual similarity…</p>\n<p>Thankfully, there is a way!</p>\n<p>Using a neural network, we can produce ‘<a href=\"https://en.wikipedia.org/wiki/Word_embedding\">embeddings</a>’ of our words. These are vectors that represent each unique word extracted from the weights of the connections within our network.</p>\n<p>But the question remains: how do we make sure they’re meaningful? The answer: feed in pairs of words as a target word and a context word. Do this enough times, throwing in some bad examples too, and the neural network begins to learn what words appear together and how this forms almost a graph. Like a social network of words interconnected by contexts. ‘Good’ goes to ‘helpful’ which goes to ‘caring’ and so on. Our task is to feed this data into the neural network.</p>\n<p>One of the most common approaches is the <a href=\"https://papers.nips.cc/paper/5021-distributed-representations-of-words-and-phrases-and-their-compositionality.pdf\">Skipgram</a> model, generating these target-context pairings based on moving a window across a dataset of text. But what if our data isn’t sentences, but we still have contextual meaning? In this tutorial, our words are artist names and our contexts are genres and mean review scores. We want artist A to be close to artist B if they share a genre and have a mean review score that is similar. So let’s get started.</p>\n<h3>Building our Dataset</h3>\n<p><a href=\"https://pitchfork.com/\">Pitchfork</a> is an online American music magazine covering mostly rock, independent, and new music. The data released to Kaggle was scraped from their website and contains information like reviews, genres, and dates linked to each artist.</p>\n<p>Let’s create an artist class and dictionary to store all of the useful information we want.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\">\n      <pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Connecting to the Kaggle Pitchfork Database</span>\n<span class=\"token keyword\">import</span> sqlite3 <span class=\"token keyword\">as</span> sql\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n\n\ndb <span class=\"token operator\">=</span> sql<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span><span class=\"token string\">'../../data/pitchfork.sqlite'</span><span class=\"token punctuation\">)</span>\ncursor <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nartist_dict <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\nartist_lookup <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">#An artist class for holding the information</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Artist</span><span class=\"token punctuation\">:</span>\n   <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       self<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name\n       self<span class=\"token punctuation\">.</span>reviews <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n       self<span class=\"token punctuation\">.</span>genres <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n       self<span class=\"token punctuation\">.</span>scores <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n   <span class=\"token keyword\">def</span> <span class=\"token function\">add_review</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> review<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       self<span class=\"token punctuation\">.</span>reviews<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>review<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">def</span> <span class=\"token function\">add_genre</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> genre<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       self<span class=\"token punctuation\">.</span>genres<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>genre<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">def</span> <span class=\"token function\">add_score</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> score<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       self<span class=\"token punctuation\">.</span>scores<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">def</span> <span class=\"token function\">__str__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>name\n\n<span class=\"token comment\">#Reading in the data and storing it as Aritst objects in our dictionary</span>\ncursor<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string\">'select reviews.reviewid, artist, genre, score from reviews join genres on genres.reviewid = reviews.reviewid'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> row <span class=\"token keyword\">in</span> cursor<span class=\"token punctuation\">:</span>\n   <span class=\"token keyword\">if</span> row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">in</span> artist_dict<span class=\"token punctuation\">:</span>\n       artist_dict<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> Artist<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n       artist_dict<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>add_review<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n       artist_dict<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>add_genre<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n       artist_dict<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>add_score<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n       artist_lookup<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>artist_lookup<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n       artist_dict<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>add_review<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n       artist_dict<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>add_genre<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n       artist_dict<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>add_score<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<p>Great! Now we want to manufacture our target-context pairings based on genre and mean review score. To do this, we’ll create two dictionaries: one for the different unique genres, and one for the scores (discretised to integers).</p>\n<p>We’ll add all our artists to the corresponding genre and mean score in these dictionaries to use later when generating pairs of artists.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\">\n      <pre class=\"language-python\"><code class=\"language-python\">genres <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\ngenre_lookup <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\nscores <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\ncursor<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string\">'select distinct genre from genres'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> row <span class=\"token keyword\">in</span> cursor<span class=\"token punctuation\">:</span>\n   genre_lookup<span class=\"token punctuation\">[</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>genre_lookup<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> row<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n   genres<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n   scores<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">#We start adding the different artists into our dictionaries</span>\n<span class=\"token keyword\">for</span> artist <span class=\"token keyword\">in</span> artist_dict<span class=\"token punctuation\">:</span>\n   <span class=\"token keyword\">for</span> genre <span class=\"token keyword\">in</span> artist_dict<span class=\"token punctuation\">[</span>artist<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>genres<span class=\"token punctuation\">:</span>\n       <span class=\"token comment\">#We don't want to add them more than once - although maybe this could be a weighting</span>\n       <span class=\"token comment\">#as in how 'rocky' are the band?</span>\n       <span class=\"token keyword\">if</span> artist <span class=\"token operator\">not</span> <span class=\"token keyword\">in</span> genres<span class=\"token punctuation\">[</span>genre<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n           genres<span class=\"token punctuation\">[</span>genre<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>artist_lookup<span class=\"token punctuation\">[</span>artist<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n   mean_score <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>artist_dict<span class=\"token punctuation\">[</span>artist<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>scores<span class=\"token punctuation\">)</span>\n   scores<span class=\"token punctuation\">[</span><span class=\"token builtin\">round</span><span class=\"token punctuation\">(</span>mean_score<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>artist_lookup<span class=\"token punctuation\">[</span>artist<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<p>One last step before we dive into the TensorFlow code: generating a batch! A batch is like a sample of data that our neural network will use for each epoch. An epoch is one sweep across the neural network in a training phase. We want to generate two numpy arrays. One will contain the following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\">\n      <pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#Our batch generator - the bias allows us to control how much of the context is from genre and how much is from score</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">gen_batch</span><span class=\"token punctuation\">(</span>genres<span class=\"token punctuation\">,</span> scores<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> bias<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n   <span class=\"token comment\">#Initialise the numpy arrays - the xs are the target words and the ys the inidividual contexts.</span>\n   xs <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>ndarray<span class=\"token punctuation\">(</span>shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>int32<span class=\"token punctuation\">)</span>\n   ys <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>ndarray<span class=\"token punctuation\">(</span>shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>int32<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">for</span> idx <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       b <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n       <span class=\"token keyword\">if</span> b <span class=\"token operator\">&lt;</span> bias<span class=\"token punctuation\">:</span>\n           genre <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>genres<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           g1 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>genres<span class=\"token punctuation\">[</span>genre_lookup<span class=\"token punctuation\">[</span>genre<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           g2 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>genres<span class=\"token punctuation\">[</span>genre_lookup<span class=\"token punctuation\">[</span>genre<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token comment\">#Probably an inefficient way to make sure we don't choose the same artist</span>\n           <span class=\"token keyword\">while</span> g1 <span class=\"token operator\">==</span> g2<span class=\"token punctuation\">:</span>\n               g2 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>genres<span class=\"token punctuation\">[</span>genre_lookup<span class=\"token punctuation\">[</span>genre<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token comment\">#Adding the artist unique integer id</span>\n           xs<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> genres<span class=\"token punctuation\">[</span>genre_lookup<span class=\"token punctuation\">[</span>genre<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>g1<span class=\"token punctuation\">]</span>\n           ys<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> genres<span class=\"token punctuation\">[</span>genre_lookup<span class=\"token punctuation\">[</span>genre<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>g2<span class=\"token punctuation\">]</span>\n       <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n           score <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>scores<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           s1 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>scores<span class=\"token punctuation\">[</span>score<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           s2 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>scores<span class=\"token punctuation\">[</span>score<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token keyword\">while</span> s1 <span class=\"token operator\">==</span> s2<span class=\"token punctuation\">:</span>\n               s2 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>scores<span class=\"token punctuation\">[</span>score<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           xs<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> scores<span class=\"token punctuation\">[</span>score<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>s1<span class=\"token punctuation\">]</span>\n           ys<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> scores<span class=\"token punctuation\">[</span>score<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>s2<span class=\"token punctuation\">]</span>\n   <span class=\"token keyword\">return</span> xs<span class=\"token punctuation\">,</span> ys\n\n<span class=\"token comment\">#A useful dictionary to go from unique integer to artist name</span>\nartist_decode <span class=\"token operator\">=</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">zip</span><span class=\"token punctuation\">(</span>artist_lookup<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> artist_lookup<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<h3>TensorFlow</h3>\n<p>There are a myriad of TensorFlow tutorials and sources of knowledge out there. Any of these <a href=\"https://medium.freecodecamp.org/search?q=tensorflow\">excellent articles</a> will help you as well as the <a href=\"https://www.tensorflow.org/tutorials/\">documentation</a>. The following code is heavily based on the <a href=\"https://github.com/tensorflow/tensorflow/blob/r1.9/tensorflow/examples/tutorials/word2vec/word2vec_basic.py\">word2vec</a> tutorial from the TensorFlow people themselves. Hopefully I can demystify some of it and boil it down to the essentials.</p>\n<p>The first step is understanding the ‘graph’ representation. This is incredibly useful for the <a href=\"https://www.tensorflow.org/guide/summaries_and_tensorboard\">TensorBoard</a> visualisations and for creating a mental image of the data flows within the neural network.</p>\n<p>Take some time to read through the code and comments below. Before we feed data to a neural network, we have to initialise all of the parts we’re going to use. The placeholders are the inputs taking whatever we give the ‘feed_dict’. The variables are mutable parts of the graph that we will eventually tweak. The most important part of our model is the loss function. It’s the score of how well we did and the treasure map to how we can improve.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\">\n      <pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#Before we dive in we need to declare some variables</span>\nvocabulary_size <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>artist_lookup<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#How big we want our final vectors to be</span>\nembedding_size <span class=\"token operator\">=</span> <span class=\"token number\">64</span>\n<span class=\"token comment\">#The number of training samples passed per epoch</span>\nbatch_size <span class=\"token operator\">=</span> <span class=\"token number\">64</span>\n<span class=\"token comment\">#Number of negative samples to use in NCE [see below]</span>\nnum_sampled <span class=\"token operator\">=</span> <span class=\"token number\">16</span>\n\n<span class=\"token comment\">#BAND2VEC - Tensorflow Time!</span>\n<span class=\"token keyword\">import</span> tensorflow <span class=\"token keyword\">as</span> tf\n<span class=\"token keyword\">import</span> math\n\ngraph <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>Graph<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">with</span> graph<span class=\"token punctuation\">.</span>as_default<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n   <span class=\"token comment\">#Defining variables and functions in a scope is good practice - adds a prefix to the operations</span>\n   <span class=\"token keyword\">with</span> tf<span class=\"token punctuation\">.</span>name_scope<span class=\"token punctuation\">(</span><span class=\"token string\">'inputs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       <span class=\"token comment\">#Tensorflow Placeholders are the mouths of the neural network - they will constantly be fed new information</span>\n       training_inputs <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>placeholder<span class=\"token punctuation\">(</span>tf<span class=\"token punctuation\">.</span>int32<span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>batch_size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n       training_labels <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>placeholder<span class=\"token punctuation\">(</span>tf<span class=\"token punctuation\">.</span>int32<span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>batch_size<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n   <span class=\"token comment\">#Using the CPU</span>\n   <span class=\"token keyword\">with</span> tf<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">(</span><span class=\"token string\">'/cpu:0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       <span class=\"token keyword\">with</span> tf<span class=\"token punctuation\">.</span>name_scope<span class=\"token punctuation\">(</span><span class=\"token string\">'embeddings'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n           <span class=\"token comment\">#The embeddings - variables are maintained across runs and need to be initialised with a shape and type</span>\n           <span class=\"token comment\">#Each row is a band represented by a vector of length 'embedding_size'</span>\n           embeddings <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>Variable<span class=\"token punctuation\">(</span>tf<span class=\"token punctuation\">.</span>random_uniform<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>vocabulary_size<span class=\"token punctuation\">,</span> embedding_size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token comment\">#Like passing muliple indices to a numpy array we get the vectors quickly with this function</span>\n           embed <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>embedding_lookup<span class=\"token punctuation\">(</span>embeddings<span class=\"token punctuation\">,</span> training_inputs<span class=\"token punctuation\">)</span>\n\n       <span class=\"token keyword\">with</span> tf<span class=\"token punctuation\">.</span>name_scope<span class=\"token punctuation\">(</span><span class=\"token string\">'weights'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n           <span class=\"token comment\">#Like embeddings we initialise our weights and also...</span>\n           nce_weights <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>Variable<span class=\"token punctuation\">(</span>\n               tf<span class=\"token punctuation\">.</span>truncated_normal<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">[</span>vocabulary_size<span class=\"token punctuation\">,</span> embedding_size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                   stddev<span class=\"token operator\">=</span><span class=\"token number\">1.0</span> <span class=\"token operator\">/</span> math<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>embedding_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n       <span class=\"token keyword\">with</span> tf<span class=\"token punctuation\">.</span>name_scope<span class=\"token punctuation\">(</span><span class=\"token string\">'biases'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n           <span class=\"token comment\">#...our biases</span>\n           nce_biases <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>Variable<span class=\"token punctuation\">(</span>tf<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>vocabulary_size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n   <span class=\"token keyword\">with</span> tf<span class=\"token punctuation\">.</span>name_scope<span class=\"token punctuation\">(</span><span class=\"token string\">'loss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       <span class=\"token comment\">#Finally our loss function - see below for an explanation of the Noise Contrastive Estimation Approach</span>\n       loss <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>reduce_mean<span class=\"token punctuation\">(</span>\n           tf<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>nce_loss<span class=\"token punctuation\">(</span>\n               weights<span class=\"token operator\">=</span>nce_weights<span class=\"token punctuation\">,</span>\n               biases<span class=\"token operator\">=</span>nce_biases<span class=\"token punctuation\">,</span>\n               labels<span class=\"token operator\">=</span>training_labels<span class=\"token punctuation\">,</span>\n               inputs<span class=\"token operator\">=</span>embed<span class=\"token punctuation\">,</span>\n               num_sampled<span class=\"token operator\">=</span>num_sampled<span class=\"token punctuation\">,</span>\n               num_classes<span class=\"token operator\">=</span>vocabulary_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n   <span class=\"token keyword\">with</span> tf<span class=\"token punctuation\">.</span>name_scope<span class=\"token punctuation\">(</span><span class=\"token string\">'optimizer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n       optimizer <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">.</span>GradientDescentOptimizer<span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>minimize<span class=\"token punctuation\">(</span>loss<span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<p>Noise Contrastive Estimation (NCE) is a loss function. Usually we would use cross-entropy and softmax, but in the natural language processing world, all of our classes amount to every single unique word.</p>\n<p>Computationally, this is bad. NCE changes the framing of the problem from probabilities of classes to whether or not a target-context pairing is correct (a binary classification). It takes a true pairing and then samples to get bad pairings, the constant num_sampled controls this. Our neural network learns to distinguish between these good and bad pairings. Ultimately, it learns the contexts! You can read more about NCE and how it works <a href=\"https://www.tensorflow.org/api_docs/python/tf/nn/nce_loss\">here</a>.</p>\n<h3>Run the Neural Network</h3>\n<p>Now that everything is set up nicely, we just have to hit the big green ‘go’ button and twiddle our thumbs for a bit.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\">\n      <pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#Running our Neural Network!</span>\n<span class=\"token comment\">#First we init the session</span>\niterations <span class=\"token operator\">=</span> <span class=\"token number\">100000</span>\n\n<span class=\"token keyword\">with</span> tf<span class=\"token punctuation\">.</span>Session<span class=\"token punctuation\">(</span>graph<span class=\"token operator\">=</span>graph<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> sess<span class=\"token punctuation\">:</span>\n   <span class=\"token comment\">#We run the initialize all global variables operation</span>\n   sess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>tf<span class=\"token punctuation\">.</span>global_variables_initializer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n   average_loss <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span>\n   <span class=\"token comment\">#For all of the iterations</span>\n   <span class=\"token keyword\">for</span> index <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>iterations<span class=\"token punctuation\">)</span>\n       <span class=\"token comment\">#Generate a batch</span>\n       ti<span class=\"token punctuation\">,</span> tl <span class=\"token operator\">=</span> gen_batch<span class=\"token punctuation\">(</span>genres<span class=\"token punctuation\">,</span> scores<span class=\"token punctuation\">,</span> batch_size<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span>\n       <span class=\"token comment\">#Put these in our feed dictionary</span>\n       feed_dict <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>training_inputs<span class=\"token punctuation\">:</span> ti<span class=\"token punctuation\">,</span> training_labels<span class=\"token punctuation\">:</span> tl<span class=\"token punctuation\">}</span>\n       <span class=\"token comment\">#Run the NN! Notice the feed dict feeding our placeholders from before</span>\n       _<span class=\"token punctuation\">,</span> loss_val <span class=\"token operator\">=</span> sess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>optimizer<span class=\"token punctuation\">,</span> loss<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> feed_dict<span class=\"token operator\">=</span>feed_dict<span class=\"token punctuation\">)</span>\n       <span class=\"token comment\">#Some metrics so we can see how we're doing</span>\n       average_loss <span class=\"token operator\">+=</span> loss_val\n       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">2000</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n           <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Average loss at step'</span><span class=\"token punctuation\">,</span> index <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> average_loss <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n   <span class=\"token comment\">#Returns our Embeddings so we can access them       </span>\n\n   final_embeddings <span class=\"token operator\">=</span> embeddings<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<h3>Visualization using TSNE</h3>\n<p>Okay, we’re not quite done. We now have context-rich, 64-dimensional vectors for our artists, but that’s perhaps too many dimensions to really visualize its usefulness.</p>\n<p>Lucky for us we can squash this information into two dimensions while retaining as many of the properties as the 64 dimensions had! This is T-distributed Stochastic Neighbor Embedding, or TSNE for short. This <a href=\"https://www.youtube.com/watch?v=NEaUSP4YerM\">video</a> does a great job of explaining the main idea behind TSNE, but I’ll try to give a broad overview.</p>\n<p>TSNE is an approach to dimensionality reduction that retains the similarities (like Euclidean distance) of higher dimensions. To do this, it first builds a matrix of point-to-point similarities calculated using a normal distribution. The centre of the distribution is the first point, and the similarity of the second point is the value of the distribution at the distance between the points away from the centre of the distribution.</p>\n<p>Then we project randomly onto the dimension below and do exactly the same process using a t-distribution. Now we have two matrices of point-to-point similarities. The algorithm then slowly moves the points in the lower dimension to try and make it look like the matrix for the higher dimension where the similarities were preserved. And repeat. Thankfully, Sci-kit Learn has a function which can do the number crunching for us.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\">\n      <pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n   <span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>manifold <span class=\"token keyword\">import</span> TSNE\n   <span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt\n\n   tsne <span class=\"token operator\">=</span> TSNE<span class=\"token punctuation\">(</span>perplexity<span class=\"token operator\">=</span><span class=\"token number\">30</span><span class=\"token punctuation\">,</span> n_components<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> verbose<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> init<span class=\"token operator\">=</span><span class=\"token string\">'pca'</span><span class=\"token punctuation\">,</span> n_iter<span class=\"token operator\">=</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> method<span class=\"token operator\">=</span><span class=\"token string\">'exact'</span><span class=\"token punctuation\">)</span>\n   plot_only <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>artist_lookup<span class=\"token punctuation\">)</span>\n\n   low_dim_embs <span class=\"token operator\">=</span> tsne<span class=\"token punctuation\">.</span>fit_transform<span class=\"token punctuation\">(</span>final_embeddings<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>plot_only<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">except</span> ImportError <span class=\"token keyword\">as</span> ex<span class=\"token punctuation\">:</span>\n   <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Please install sklearn, matplotlib, and scipy to show embeddings.'</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>ex<span class=\"token punctuation\">)</span></code></pre>\n      </div>\n<h3>The Results</h3>\n<p><img src=\"https://res.cloudinary.com/patricoferris/image/upload/v1534280792/pf2018/blogposts/14-08-2018/LOW_DIM_EMBS_ALL.png\" alt=\"All of the Artists plotted using their low dimensional embedding\"></p>\n<p>The amazing aspect of these embeddings is that, just like vectors, they support mathematical operations. The classic example being: King — Man + Woman = Queen , or at least very close to it. Let’s try an example.</p>\n<p>Take the low dimensional embeddings of Coil, a band with the following genres, [‘electronic’, ‘experimental', ‘rock’] , and mean score 7.9. Now subtract the low dimensional embeddings of Elder Ones, a band with genres,['electronic'] , and mean score 7.8. With this embedding difference, find the closest bands to it and print their names and genres.</p>\n<p>Artist: black lips, Mean Score: 7.48, Genres: ['rock', 'rock', 'rock', 'rock', 'rock']</p>\n<p>Artist: crookers, Mean Score: 5.5, Genres: ['electronic']</p>\n<p>Artist: guided by voices, Mean Score: 7.23043478261, Genres: ['rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock', 'rock']</p>\n<p>It worked! We’re getting rock and electronic bands with vaguely similar review scores. Below are the first three hundred bands plotted with labels. Hopefully you’ve found this project educational and inspiring. Go forth and build, explore, and play!</p>\n<p><img src=\"https://res.cloudinary.com/patricoferris/image/upload/v1534280789/pf2018/blogposts/14-08-2018/FIRST_300.png\" alt=\"Three hundred artists plotted and labelled\"></p>","frontmatter":{"path":"/tensorflow-word2vec-tsne","title":"Learn TensorFlow, the Word2Vec model, and the TSNE algorithm using rock bands","subtitle":"A guide to vectorising your favourite musicians","date":"2018-08-14","imageUrl":"https://res.cloudinary.com/patricoferris/image/upload/v1534280789/pf2018/blogposts/14-08-2018/KMEANS_CLUSTERING.png"}}},"pathContext":{}}